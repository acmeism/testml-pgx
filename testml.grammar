---
ALWAYS: //        # Always match
ANY: /[\s\S]/     # Any unicode character
SPACE: /[\ \t]/   # A space or tab character
SPACES: /\ \t/    #   For use in character classes
BREAK: /\n/       # A newline character
EOL: /\r?\n/      # A Unix or DOS line ending
NON_BREAK: /./    # Any character except newline
LOWER: /[a-z]/    # Lower case ASCII alphabetic character
UPPER: /[A-Z]/    # Upper case ASCII alphabetic character
ALPHANUM: /[A-Za-z0-9]/    # ASCII alphanumeric character
WORD: /\w/        # ie /[A-Za-z0-9_]/ - A "word" character
DIGIT: /[0-9]/    # A numeric digit
STAR: /\*/        # An asterisk
DOT: /\./         # A period character
SEMI: /;/         # A semicolon
HASH: /#/         # An octothorpe (or hash) character
BACK: /\/         # A backslash character
SINGLE: /'/       # A single quote character
DOUBLE: /"/       # A double quote character
ESCAPE: /[0nt]/   # One of the escapable character IDs

line: /<NON_BREAK>*<EOL>/
blank_line: /<SPACE>*<EOL>/
comment: /<HASH><line>/
ws: /(?:<SPACE>|<EOL>|<comment>)/

quoted_string: /(?:<single_quoted_string>|<double_quoted_string>)/
single_quoted_string: /(?:<SINGLE>(([^<BREAK><BACK><SINGLE>]|<BACK><SINGLE>|<BACK><BACK>)*?)<SINGLE>)/

double_quoted_string: /(?:<DOUBLE>(([^<BREAK><BACK><DOUBLE>]|<BACK><DOUBLE>|<BACK><BACK>|<BACK><ESCAPE>)*?)<DOUBLE>)/

unquoted_string: /[^<SPACES><BREAK><HASH>](?:[^<BREAK><HASH>]*[^<SPACES><BREAK><HASH>])?/

TOP: <document>

document:
- <meta_section>
- <test_section>
- <data_section>?

meta_section:
- /(?:<comment>|<blank_line>)*/
- ( <meta_testml_statement> | <NO_META_TESTML_ERROR> )
- ( <meta_statement> | <comment> | <blank_line> )


meta_testml_statement: /%TestML:<SPACE>+(<testml_version>)(?:<SPACE>+<comment>|<EOL>)/

testml_version: /(<DIGIT><DOT><DIGIT>+)/

meta_statement: /%(<meta_keyword>):<SPACE>+(<meta_value>)(?:<SPACE>+<comment>|<EOL>)/

meta_keyword: /(?:<core_meta_keyword>|<user_meta_keyword>)/
core_meta_keyword: /(?:Title|Data|Plan|BlockMarker|PointMarker)/
user_meta_keyword: /<LOWER><WORD>*/

meta_value: /(?:<quoted_string>|<unquoted_string>)/


test_section: ( <ws> | <test_statement> )*

test_statement:
- <test_statement_start>
- <test_expression>
- <assertion_call>?
- ( <SEMI> | <SEMICOLON_ERROR> )

token test_statement_start: <ALWAYS>

test_expression:
- <sub_expression>
- (
    <!assertion_function_call>
    <call_indicator>
    <sub_expression>
  )*

sub_expression: (
    <transform_call> |
    <point_call> |
    <string_call> |
    <constant_call>
  )

string_call: <quoted_string>

transform_call:
- <transform_name>
- /\(/
- <transform_argument_list_start>
- /<ws>*/
- <argument_list>
- /<ws>*/
- <transform_argument_list_stop>
- /\)/

transform_name: ( <user_transform> | <core_transform> )

user_transform: /(<LOWER><WORD>*)/

core_transform: /(<UPPER><WORD>*)/

call_indicator: /(?:<DOT><ws>*|<ws>*<DOT>)/

point_call: /(<STAR><LOWER><WORD>*)/

constant_call: /(<UPPER><WORD>*)/

transform_argument_list_start: <ALWAYS>

transform_argument_list:
- <transform_argument>
- ( /<ws>*,<ws>*/ <transform_argument> )*
- <?>

transform_argument_list_stop: <ALWAYS>

transform_argument: <sub_expression>

assertion_call: (
    <assertion_operator_call> |
    <assertion_function_call>
  )

assertion_operator_call:
- /<ws>+/
- <assertion_operator>
- /<ws>+/
- <test_expression>

assertion_operator: /(==)/

assertion_function_call:
- /<call_indicator><assertion_name>\(<ws>*/
- <test_expression>
- /<ws>*\)/

assertion_function_name: /EQ/

data_section: /(<block_marker>(?:<SPACE>|<EOL>)<ANY>+|\Z)/

data: <data_block>*

data_block:
- <block_header>
- ( <blank_line> | <comment> )
- <block_point>*

block_header:
- <block_marker>
- ( /<SPACE>+/ <block_label> )?
- /<SPACE>*<EOL>/

block_marker: /===/

block_label: <unquoted_string>

block_point: ( <lines_point> | <phrase_point> )

lines_point:
- /<point_marker><SPACE>+/
- <point_name>
- /<SPACE>*<EOL>/
- <point_lines>

point_lines: /((?:(?!<block_marker>|<point_marker>)<line>)*)/

phrase_point:
- /<point_marker><SPACE>+/
- <point_name>
- /:<SPACE>/
- <point_phrase>
- /<EOL>/
- /(?:<comment>|<blank_line>)*/

point_marker: /---/

point_name: ( <core_point_name> | <user_point_name> )

core_point_name: /(<UPPER><WORD>*)/

user_point_name: /(<LOWER><WORD>*)/

point_phrase: /(<unquoted_string>)/
